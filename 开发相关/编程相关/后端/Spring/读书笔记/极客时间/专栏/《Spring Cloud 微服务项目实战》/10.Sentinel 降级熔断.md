@SentinelResource 注解中使用 blockHandler 属性指定降级方法只有在服务抛出 BlockException 异常的情况下才会生效。
```ad-note
title:什么是 BlockException 异常？
这个异常类是 Sentinel 组件自带的类，当一个请求被 Sentinel 规则拦截，这个异常便会被抛出。比如请求被 Sentinel 流控策略阻拦住，或者请求被熔断策略阻断了，这些情况下你可以使用 SentinelResource 的 blockHandler 注解来指定降级逻辑。但是对于其它 RuntimeException 的异常类型它就无能为力了。
```
# 通用降级逻辑 fallback 属性
如果降级方法的方法签名是 BlockException，那么 fallback 是无法正常工作的。

在注解中同时使用了 fallback 和 blockHandler 属性，如果服务抛出 BlockException，则执行 blockHandler 属性指定的方法，其他异常就由fallback 属性所对应的降级方法接管。

如果你不想把降级方法定义在当前 Class 中，而是想新建一个 Class 来统一管理这些降级逻辑，那么你可以通过 SentinelResource 注解的fallbackClass 属性指定一个保存降级逻辑的 Class。
# Sentinel 熔断规则
## 异常比例
在 10 秒的统计窗口内，如果异常调用的比例超过了 60%，并且满足请求数量 >=5，就开启一段为期 5 秒的熔断时间。
![[Pasted image 20220811213015.png]]
## 异常数
熔断规则和前面我们设置的异常比例熔断规则几乎一样，唯一的区别就是“异常数”的判定条件是统计窗口内发生异常的个数，而不是去统计异常请求的比例。
## 慢调用比例
通常来说，慢调用请求所占比例逐渐增多，这是服务雪崩的前兆。为了将影响范围缩小，我们要做的就是尽早捕捉到慢调用请求的比例变化趋势，及时通过熔断规则对服务进行减压。

需要注意的是，当服务请求超过设置的最大响应时间，Sentinel 只是会将该次请求作为一次慢响应加入到统计数据里，并不会将这个请求直接阻塞掉。因此，这里的最大 RT 只是一个用来做统计的条件参数，而不是超时判定的参数。
# Sentinel 熔断开关的状态转换
Sentinel 的熔断器会在开启、关闭和半开这三种逻辑状态之间来回切换。
![[Pasted image 20220811215102.png]]
从图中可以看出，在第一个统计窗口内熔断器是处于关闭状态的，达到熔断判定条件之后，Sentinel 开启了一段熔断窗口。在这段窗口时间内，熔断器是处于开启状态的，这时新的服务请求会执行降级逻辑。待熔断窗口结束，Sentinel 会将熔断器状态置为“半开”状态，这是一个介于完全开启和完全关闭之间的中间态。

在半开状态下，如果有一个新请求过来，那么 Sentinel 会试探性地让这个请求去执行正常的业务逻辑，如果执行成功，那么 Sentinel 将关闭熔断器并退出熔断状态，如果执行失败，那么 Sentinel 将再次开启一个新的熔断窗口。

从这里我们可以得出一个信息，当熔断器处于“半开”状态时，只要下一个请求失败，就立即打回熔断状态，并不需要再次满足熔断规则中设置的各种条件。

