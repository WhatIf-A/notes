1. 负载均衡的作用：了解负载均衡的两大门派，它们分别是网关层负载均衡和客户端负载均衡。你还会理解客户端负载均衡在微服务架构中的优势。
2. Loadbalancer 工作原理：了解 Loadbalancer 如何运用 @Loadbalanced 注解进行加载。
3. 自定义负载均衡策略：了解 Loadbalancer 的自定义扩展点，在实战项目中实现金丝雀测试。
# 为什么需要负载均衡
我们需要将访问流量分散到集群中的各个服务器上，实现雨露均沾，这就是所谓 的“负载均衡技术”。

负载均衡有两大门派，服务端负载均 衡和客户端负载均衡。
## 网关层负载均衡
网关层负载均衡也被称为服务端负载均衡，就是在服务集群内设置一个中心化负载均衡器，比如 API Gateway 服务。发起服务间调用的时候，服务请求并不直接发向目标服务器，而是发给这个全局负载均衡器，它再根据配置的负载均衡策略将请求转发到目标服务。
![[Pasted image 20220806171730.png]]
网关层负载均衡的应用范围非常广，它不依赖于服务发现技术，客户端并不需要拉取完整的服务列表；同时，发起服务调用的客户端也不用操心该使用什么负载均衡策略。

不过，网关层负载均衡的劣势也很明显。
1. 网络消耗：多了一次客户端请求网关层的网络开销，在线上高并发场景下这层调用会增加 10ms～20ms 左右的服务响应时间。别小瞧了这十几毫秒的时间，在超高 QPS 的场景下，性能损耗也会被同步放大，降低系统的吞吐量。
2. 复杂度和故障率提升：需要额外搭建内部网关组件作为负载均衡器，增加了系统复杂度，而多出来的那一次的网络调用无疑也增加了请求失败率。
## 客户端负载均衡
Spring Cloud Loadbalancer 采用了客户端负载均衡技术，每个发起服务调用的客户端都存有完整的目标服务地址列表，根据配置的负载均衡策略，由客户端自己决定向哪台服务器发起调用。

客户端负载均衡的优势很明显。
1. 网络开销小：由客户端直接发起点对点的服务调用，没有中间商赚差价。
2. 配置灵活：各个客户端可以根据自己的需要灵活定制负载均衡策略。
不过呢，如果想要应用客户端负载均衡，那么还需要满足一个前置条件，发起服务调用的客户端需要获取所有目标服务的地址，这样它才能使用负载均衡规则选取要调用的服务。 也就是说，客户端负载均衡技术往往需要依赖服务发现技术来获取服务列表。
# Loadbalancer 工作原理
第一步，声明负载均衡过滤器。ReactorLoadBalancerClientAutoConfiguration 是一个自动装配器类，我们在项目中引入了 WebClient 和 ReactiveLoadBalancer 类之后，自动装配流程就开始忙活起来了。在这个过程中，它会初始化一个实现了 ExchangeFilterFunction 的实例，在后面的步骤中，该实例将作为过滤器被注入到 WebClient。

第二步，声明后置处理器。LoadBalancerBeanPostProcessorAutoConfiguration 是第二个登场的自动装配器，它的主要作用是将第一步中创建的 ExchangeFilterFunction 拦截器实例添加到一个后置处理器（LoadBalancerWebClientBuilderBeanPostProcessor）中。

第三步，添加过滤器到 WebClient。LoadBalancerWebClientBuilderBeanPostProcessor 后置处理器开始发挥作用，将过滤器添加到 WebClient 中。注意不是所有的 WebClient 都会被注入过滤器，只有被 @Loadbalanced 注解修饰的 WebClient 实例才能享受这个待遇。
# 自定义负载均衡策略实现金丝雀测试
Loadbalancer 提供了两种内置负载均衡策略。
1. RandomLoadBalancer：在服务列表中随机挑选一台服务器发起调用，属于拼人品系列。
2. RoundRobinLoadBalancer：通过内部保存的一个 position 计数器，按照次序从上到下依次调用服务，每次调用后计数器 +1，属于排好队一个个来系列。
## 如果以上负载均衡策略无法满足你的要求，那么应该怎么实现自定义的负载均衡策略呢？
Loadbalancer 提供了一个顶层的抽象接口 ReactiveLoadBalancer，你可以通过继承这个接口，来实现自定义的负载均衡策略。现在我就带你沿着这个路子实现一个用于“金丝雀 测试”的负载均衡策略，在动手之前，我先带你了解一下什么是“金丝雀测试”。
# 金丝雀测试
金丝雀测试是灰度测试的一种。

我们的线上应用平稳运行在一个集群中，当你想要上线一个涉及上下游代码改动的线上应用的时候，首先想到的是先要做一个线上测试。这个测试必须在极小规模的范围内进行，不能影响到整个集群。

我们可以把代码改动部署到极个别的几台机器上，这几台机器就叫做“金丝雀”。只有带着“测试流量标记”的请求会被发到这几台服务器上，而正常的流量只会打到集群中的其它机器上。下面的图解释了金丝雀测试的流程。
![[Pasted image 20220806175717.png]]







